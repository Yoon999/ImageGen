<Window x:Class="ImageGen.Views.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:vm="clr-namespace:ImageGen.ViewModels"
        xmlns:helpers="clr-namespace:ImageGen.Helpers"
        mc:Ignorable="d"
        Title="NovelAI Image Generator" Height="850" Width="900">
    
    <Window.Resources>
        <helpers:CountToBoolConverter x:Key="CountToBoolConverter"/>
        <helpers:InverseBoolConverter x:Key="InverseBoolConverter"/>
    </Window.Resources>

    <Window.DataContext>
        <vm:MainViewModel/>
    </Window.DataContext>

    <Grid Margin="10">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/> <!-- Top Bar (Token) -->
            <RowDefinition Height="*"/>    <!-- Main Content -->
            <RowDefinition Height="Auto"/> <!-- Status Bar -->
        </Grid.RowDefinitions>

        <!-- 1. Top Bar: API Token -->
        <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,10">
            <TextBlock Text="API Token:" VerticalAlignment="Center" Margin="0,0,10,0"/>
            <TextBox Text="{Binding ApiToken, UpdateSourceTrigger=PropertyChanged}" Width="300" VerticalAlignment="Center"/>
            <TextBlock Text="(Required)" Foreground="Gray" VerticalAlignment="Center" Margin="10,0,0,0"/>
        </StackPanel>

        <!-- 2. Main Content -->
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="300"/> <!-- Controls -->
                <ColumnDefinition Width="*"/>   <!-- Image Viewer -->
            </Grid.ColumnDefinitions>

            <!-- Left Panel: Controls -->
            <ScrollViewer Grid.Column="0" VerticalScrollBarVisibility="Auto" Margin="0,0,10,0">
                <StackPanel>
                    <TextBlock Text="Prompt" FontWeight="Bold" Margin="0,0,0,5"/>
                    
                    <!-- Prompt Input with AutoComplete Popup -->
                    <Grid>
                        <TextBox x:Name="PromptBox" 
                                 Text="{Binding Prompt, UpdateSourceTrigger=PropertyChanged}" 
                                 Height="100" TextWrapping="Wrap" AcceptsReturn="True" VerticalScrollBarVisibility="Auto"
                                 Margin="0,0,0,15"/>
                        
                        <Popup IsOpen="{Binding TagSuggestions.Count, Mode=OneWay, Converter={StaticResource CountToBoolConverter}}" 
                               PlacementTarget="{Binding ElementName=PromptBox}"
                               Placement="Bottom"
                               StaysOpen="False"
                               MaxHeight="200" Width="280">
                            <Border Background="White" BorderBrush="Gray" BorderThickness="1">
                                <ListBox ItemsSource="{Binding TagSuggestions}" 
                                         SelectedItem="{Binding SelectedSuggestion}"
                                         x:Name="SuggestionList">
                                    <ListBox.ItemTemplate>
                                        <DataTemplate>
                                            <StackPanel Orientation="Horizontal">
                                                <TextBlock Text="{Binding Tag}" FontWeight="Bold"/>
                                                <TextBlock Text="{Binding Count, StringFormat=' ({0})'}" Foreground="Gray"/>
                                            </StackPanel>
                                        </DataTemplate>
                                    </ListBox.ItemTemplate>
                                </ListBox>
                            </Border>
                        </Popup>
                    </Grid>

                    <TextBlock Text="Negative Prompt" FontWeight="Bold" Margin="0,0,0,5"/>
                    <TextBox Text="{Binding NegativePrompt, UpdateSourceTrigger=PropertyChanged}" 
                             Height="60" TextWrapping="Wrap" AcceptsReturn="True" VerticalScrollBarVisibility="Auto"
                             Margin="0,0,0,15"/>

                    <TextBlock Text="Parameters" FontWeight="Bold" Margin="0,0,0,5"/>
                    
                    <!-- Width -->
                    <DockPanel Margin="0,0,0,5">
                        <TextBlock Text="Width:" Width="50"/>
                        <TextBox Text="{Binding Request.parameters.width}" Width="50" DockPanel.Dock="Right"/>
                        <Slider Minimum="64" Maximum="2048" Value="{Binding Request.parameters.width}" TickFrequency="64" IsSnapToTickEnabled="True"/>
                    </DockPanel>

                    <!-- Height -->
                    <DockPanel Margin="0,0,0,5">
                        <TextBlock Text="Height:" Width="50"/>
                        <TextBox Text="{Binding Request.parameters.height}" Width="50" DockPanel.Dock="Right"/>
                        <Slider Minimum="64" Maximum="2048" Value="{Binding Request.parameters.height}" TickFrequency="64" IsSnapToTickEnabled="True"/>
                    </DockPanel>

                    <!-- Steps -->
                    <DockPanel Margin="0,0,0,5">
                        <TextBlock Text="Steps:" Width="50"/>
                        <TextBox Text="{Binding Request.parameters.steps}" Width="50" DockPanel.Dock="Right"/>
                        <Slider Minimum="1" Maximum="50" Value="{Binding Request.parameters.steps}"/>
                    </DockPanel>

                    <!-- Scale -->
                    <DockPanel Margin="0,0,0,5">
                        <TextBlock Text="Scale:" Width="50"/>
                        <TextBox Text="{Binding Request.parameters.scale}" Width="50" DockPanel.Dock="Right"/>
                        <Slider Minimum="1.0" Maximum="20.0" Value="{Binding Request.parameters.scale}"/>
                    </DockPanel>

                    <!-- CfgRescale -->
                    <DockPanel Margin="0,0,0,5">
                        <TextBlock Text="Rescale:" Width="50"/>
                        <TextBox Text="{Binding CfgRescale, StringFormat=N2}" Width="50" DockPanel.Dock="Right"/>
                        <Slider Minimum="0.0" Maximum="1.0" Value="{Binding CfgRescale}" TickFrequency="0.05" IsSnapToTickEnabled="True"/>
                    </DockPanel>

                    <!-- Sampler -->
                    <DockPanel Margin="0,0,0,5">
                        <TextBlock Text="Sampler:" Width="50" VerticalAlignment="Center"/>
                        <ComboBox ItemsSource="{Binding Samplers}" SelectedItem="{Binding SelectedSampler}" DockPanel.Dock="Right"/>
                    </DockPanel>

                    <!-- Seed -->
                    <TextBlock Text="Seed:" Margin="0,5,0,0"/>
                    <DockPanel Margin="0,0,0,15">
                        <CheckBox Content="Random" IsChecked="{Binding IsRandomSeed}" VerticalAlignment="Center" Margin="0,0,10,0"/>
                        <Button Content="?" Command="{Binding RandomizeSeedCommand}" Width="30" Margin="0,0,5,0" ToolTip="Randomize Seed"/>
                        <TextBox Text="{Binding Seed, UpdateSourceTrigger=PropertyChanged}" IsEnabled="{Binding IsRandomSeed, Converter={StaticResource InverseBoolConverter}}"/>
                    </DockPanel>

                    <!-- Save Directory -->
                    <TextBlock Text="Save Directory" FontWeight="Bold" Margin="0,0,0,5"/>
                    <Grid Margin="0,0,0,15">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <TextBox Text="{Binding SaveDirectory}" VerticalAlignment="Center" Margin="0,0,5,0"/>
                        <Button Grid.Column="1" Content="..." Command="{Binding SelectFolderCommand}" Width="30" Height="25"/>
                    </Grid>

                    <!-- Generate Button -->
                    <Button Content="Generate Image" Command="{Binding GenerateCommand}" Height="40" FontSize="16" FontWeight="Bold"/>
                </StackPanel>
            </ScrollViewer>

            <!-- Right Panel: Image Viewer -->
            <Border Grid.Column="1" BorderBrush="Gray" BorderThickness="1" Background="#F0F0F0">
                <Image Source="{Binding GeneratedImage}" Stretch="Uniform"/>
            </Border>
        </Grid>

        <!-- 3. Status Bar -->
        <StatusBar Grid.Row="2" Margin="0,10,0,0">
            <StatusBarItem>
                <TextBlock Text="{Binding StatusMessage}"/>
            </StatusBarItem>
        </StatusBar>
    </Grid>
</Window>
